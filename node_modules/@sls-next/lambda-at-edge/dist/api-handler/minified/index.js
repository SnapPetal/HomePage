"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./manifest.json"),t=require("./routes-manifest.json"),r=require("stream"),n=require("zlib"),o=require("http");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=i(e),a=i(t),u=i(r),c=i(n),d=i(o);const f={"accept-encoding":!0,"content-length":!0,"if-modified-since":!0,"if-none-match":!0,"if-range":!0,"if-unmodified-since":!0,"transfer-encoding":!0,via:!0},l={202:"Accepted",502:"Bad Gateway",400:"Bad Request",409:"Conflict",100:"Continue",201:"Created",417:"Expectation Failed",424:"Failed Dependency",403:"Forbidden",504:"Gateway Timeout",410:"Gone",505:"HTTP Version Not Supported",418:"I'm a teapot",419:"Insufficient Space on Resource",507:"Insufficient Storage",500:"Server Error",411:"Length Required",423:"Locked",420:"Method Failure",405:"Method Not Allowed",301:"Moved Permanently",302:"Moved Temporarily",207:"Multi-Status",300:"Multiple Choices",511:"Network Authentication Required",204:"No Content",203:"Non Authoritative Information",406:"Not Acceptable",404:"Not Found",501:"Not Implemented",304:"Not Modified",200:"OK",206:"Partial Content",402:"Payment Required",308:"Permanent Redirect",412:"Precondition Failed",428:"Precondition Required",102:"Processing",407:"Proxy Authentication Required",431:"Request Header Fields Too Large",408:"Request Timeout",413:"Request Entity Too Large",414:"Request-URI Too Long",416:"Requested Range Not Satisfiable",205:"Reset Content",303:"See Other",503:"Service Unavailable",101:"Switching Protocols",307:"Temporary Redirect",429:"Too Many Requests",401:"Unauthorized",422:"Unprocessable Entity",415:"Unsupported Media Type",305:"Use Proxy"},p={enableHTTPCompression:!1},h=(e,{enableHTTPCompression:t,rewrittenUri:r}=p)=>{const{request:n,response:o={headers:{}}}=e,i={headers:{}},s=new u.default.Readable,a=Object.assign(s,d.default.IncomingMessage.prototype);a.url=r||n.uri,a.method=n.method,a.rawHeaders=[],a.headers={},a.connection={},n.querystring&&(a.url=a.url+"?"+n.querystring);const h=n.headers||{};for(const e of Object.keys(h)){const t=h[e];t.forEach((e=>{a.rawHeaders.push(e.key),a.rawHeaders.push(e.value)})),a.headers[e]=t[0].value}a.getHeader=e=>a.headers[e.toLowerCase()],a.getHeaders=()=>a.headers,n.body&&n.body.data&&a.push(n.body.data,n.body.encoding?"base64":void 0),a.push(null);const y=new u.default;y.finished=!1,Object.defineProperty(y,"statusCode",{get:()=>i.status,set(e){i.status=e,i.statusDescription=l[e]}}),y.headers={};const v={};y.writeHead=(e,t)=>(i.status=e,t&&(y.headers=Object.assign(y.headers,t)),y),y.write=e=>{i.body||(i.body=Buffer.from("")),i.body=Buffer.concat([i.body,Buffer.isBuffer(e)?e:Buffer.from(e)])};let m=t&&(e=>{let t=!1;const r=e["accept-encoding"];if(r)for(let e=0;e<r.length;e++){const{value:n}=r[e];-1!==n.split(",").map((e=>e.split(";")[0].trim())).indexOf("gzip")&&(t=!0)}return t})(h);const g=new Promise((e=>{y.end=t=>{!0!==y.finished&&(y.finished=!0,t&&y.write(t),y.statusCode||(y.statusCode=200),i.body&&(i.bodyEncoding="base64",i.body=m?c.default.gzipSync(i.body).toString("base64"):Buffer.from(i.body).toString("base64")),i.headers=((e,t,r)=>{const n={},o={};return Object.entries(r).forEach((([e,t])=>{o[e.toLowerCase()]=t})),Object.entries(e).forEach((([e,r])=>{const i=e.toLowerCase();e=t[i]||e,f[i]?o[i]&&(n[i]=o[i]):(n[i]=[],r instanceof Array?r.forEach((t=>{n[i].push({key:e,value:t.toString()})})):n[i].push({key:e,value:r.toString()}))})),n})(y.headers,v,o.headers),m&&(i.headers["content-encoding"]=[{key:"Content-Encoding",value:"gzip"}]),e(i))}}));return y.setHeader=(e,t)=>{y.headers[e.toLowerCase()]=t,v[e.toLowerCase()]=e},y.removeHeader=e=>{delete y.headers[e.toLowerCase()]},y.getHeader=e=>y.headers[e.toLowerCase()],y.getHeaders=()=>y.headers,y.hasHeader=e=>!!y.getHeader(e),{req:a,res:y,responsePromise:g}};h.SPECIAL_NODE_HEADERS=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];var y=h;const v=["connection","expect","keep-alive","proxy-authenticate","proxy-authorization","proxy-connection","trailer","upgrade","x-accel-buffering","x-accel-charset","x-accel-limit-rate","x-accel-redirect","x-cache","x-forwarded-proto","x-real-ip","content-length","host","transfer-encoding","via"],m=["x-amz-cf-","x-amzn-","x-edge-"];function g(e){const t=e.toLowerCase();for(const e of m)if(t.startsWith(e))return!0;return v.includes(t)}function x(e,t){void 0===t&&(t={});for(var r=function(e){for(var t=[],r=0;r<e.length;){var n=e[r];if("*"!==n&&"+"!==n&&"?"!==n)if("\\"!==n)if("{"!==n)if("}"!==n)if(":"!==n)if("("!==n)t.push({type:"CHAR",index:r,value:e[r++]});else{var o=1,i="";if("?"===e[a=r+1])throw new TypeError('Pattern cannot start with "?" at '+a);for(;a<e.length;)if("\\"!==e[a]){if(")"===e[a]){if(0==--o){a++;break}}else if("("===e[a]&&(o++,"?"!==e[a+1]))throw new TypeError("Capturing groups are not allowed at "+a);i+=e[a++]}else i+=e[a++]+e[a++];if(o)throw new TypeError("Unbalanced pattern at "+r);if(!i)throw new TypeError("Missing pattern at "+r);t.push({type:"PATTERN",index:r,value:i}),r=a}else{for(var s="",a=r+1;a<e.length;){var u=e.charCodeAt(a);if(!(u>=48&&u<=57||u>=65&&u<=90||u>=97&&u<=122||95===u))break;s+=e[a++]}if(!s)throw new TypeError("Missing parameter name at "+r);t.push({type:"NAME",index:r,value:s}),r=a}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),n=t.prefixes,o=void 0===n?"./":n,i="[^"+E(t.delimiter||"/#?")+"]+?",s=[],a=0,u=0,c="",d=function(e){if(u<r.length&&r[u].type===e)return r[u++].value},f=function(e){var t=d(e);if(void 0!==t)return t;var n=r[u],o=n.type,i=n.index;throw new TypeError("Unexpected "+o+" at "+i+", expected "+e)},l=function(){for(var e,t="";e=d("CHAR")||d("ESCAPED_CHAR");)t+=e;return t};u<r.length;){var p=d("CHAR"),h=d("NAME"),y=d("PATTERN");if(h||y){var v=p||"";-1===o.indexOf(v)&&(c+=v,v=""),c&&(s.push(c),c=""),s.push({name:h||a++,prefix:v,suffix:"",pattern:y||i,modifier:d("MODIFIER")||""})}else{var m=p||d("ESCAPED_CHAR");if(m)c+=m;else if(c&&(s.push(c),c=""),d("OPEN")){v=l();var g=d("NAME")||"",x=d("PATTERN")||"",w=l();f("CLOSE"),s.push({name:g||(x?a++:""),pattern:g&&!x?i:x,prefix:v,suffix:w,modifier:d("MODIFIER")||""})}else f("END")}}return s}function w(e,t){return function(e,t){void 0===t&&(t={});var r=C(t),n=t.encode,o=void 0===n?function(e){return e}:n,i=t.validate,s=void 0===i||i,a=e.map((function(e){if("object"==typeof e)return new RegExp("^(?:"+e.pattern+")$",r)}));return function(t){for(var r="",n=0;n<e.length;n++){var i=e[n];if("string"!=typeof i){var u=t?t[i.name]:void 0,c="?"===i.modifier||"*"===i.modifier,d="*"===i.modifier||"+"===i.modifier;if(Array.isArray(u)){if(!d)throw new TypeError('Expected "'+i.name+'" to not repeat, but got an array');if(0===u.length){if(c)continue;throw new TypeError('Expected "'+i.name+'" to not be empty')}for(var f=0;f<u.length;f++){var l=o(u[f],i);if(s&&!a[n].test(l))throw new TypeError('Expected all "'+i.name+'" to match "'+i.pattern+'", but got "'+l+'"');r+=i.prefix+l+i.suffix}}else if("string"!=typeof u&&"number"!=typeof u){if(!c){var p=d?"an array":"a string";throw new TypeError('Expected "'+i.name+'" to be '+p)}}else{l=o(String(u),i);if(s&&!a[n].test(l))throw new TypeError('Expected "'+i.name+'" to match "'+i.pattern+'", but got "'+l+'"');r+=i.prefix+l+i.suffix}}else r+=i}return r}}(x(e,t),t)}function b(e,t){var r=[];return function(e,t,r){void 0===r&&(r={});var n=r.decode,o=void 0===n?function(e){return e}:n;return function(r){var n=e.exec(r);if(!n)return!1;for(var i=n[0],s=n.index,a=Object.create(null),u=function(e){if(void 0===n[e])return"continue";var r=t[e-1];"*"===r.modifier||"+"===r.modifier?a[r.name]=n[e].split(r.prefix+r.suffix).map((function(e){return o(e,r)})):a[r.name]=o(n[e],r)},c=1;c<n.length;c++)u(c);return{path:i,index:s,params:a}}}($(e,r,t),r,t)}function E(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function C(e){return e&&e.sensitive?"":"i"}function R(e,t,r){return function(e,t,r){void 0===r&&(r={});for(var n=r.strict,o=void 0!==n&&n,i=r.start,s=void 0===i||i,a=r.end,u=void 0===a||a,c=r.encode,d=void 0===c?function(e){return e}:c,f="["+E(r.endsWith||"")+"]|$",l="["+E(r.delimiter||"/#?")+"]",p=s?"^":"",h=0,y=e;h<y.length;h++){var v=y[h];if("string"==typeof v)p+=E(d(v));else{var m=E(d(v.prefix)),g=E(d(v.suffix));if(v.pattern)if(t&&t.push(v),m||g)if("+"===v.modifier||"*"===v.modifier){var x="*"===v.modifier?"?":"";p+="(?:"+m+"((?:"+v.pattern+")(?:"+g+m+"(?:"+v.pattern+"))*)"+g+")"+x}else p+="(?:"+m+"("+v.pattern+")"+g+")"+v.modifier;else p+="("+v.pattern+")"+v.modifier;else p+="(?:"+m+g+")"+v.modifier}}if(u)o||(p+=l+"?"),p+=r.endsWith?"(?="+f+")":"$";else{var w=e[e.length-1],b="string"==typeof w?l.indexOf(w[w.length-1])>-1:void 0===w;o||(p+="(?:"+l+"(?="+f+"))?"),b||(p+="(?="+l+"|"+f+")")}return new RegExp(p,C(r))}(x(e,r),t,r)}function $(e,t,r){return e instanceof RegExp?function(e,t){if(!t)return e;for(var r=/\((?:\?<(.*?)>)?(?!\?)/g,n=0,o=r.exec(e.source);o;)t.push({name:o[1]||n++,prefix:"",suffix:"",modifier:"",pattern:""}),o=r.exec(e.source);return e}(e,t):Array.isArray(e)?function(e,t,r){var n=e.map((function(e){return $(e,t,r).source}));return new RegExp("(?:"+n.join("|")+")",C(r))}(e,t,r):R(e,t,r)}function q(e,t,r=null){if(t.i18n){const n=null!=r?r:t.i18n.defaultLocale,o=t.i18n.locales,i=e.startsWith(t.basePath)?t.basePath:"";for(const t of o)if(e===`${i}/${t}`||e.startsWith(`${i}/${t}/`))return"string"==typeof r?e.replace(`${t}/`,`${r}/`):e;return"/"===e||e===`${i}`?`${i}/${n}`:e.replace(`${i}/`,`${i}/${n}/`)}return e}function T(e,t){return b(t,{decode:decodeURIComponent})(e)}function A(e,t){try{const r=e.toLowerCase();if(r.startsWith("https://")||r.startsWith("http://")){const{origin:r,pathname:n}=new URL(e),o=`${r}${w(n,{encode:encodeURIComponent})(t)}`;return!e.endsWith("/")&&o.endsWith("/")?o.slice(0,-1):o}{const r=e.replace(/\?/g,"\\?");return w(r,{encode:encodeURIComponent})(t)}}catch(t){return console.error(`Could not compile destination ${e}, returning null instead. Error: ${t}`),null}}const P=(e,t)=>{var r;const[n]=(null!==(r=e.req.url)&&void 0!==r?r:"").split("?"),o=((e,t)=>{const r=q(e,t),n={};for(const e of t.headers)if(T(r,e.source))for(const{key:t,value:r}of e.headers)t&&(n[t.toLowerCase()]=[{key:t,value:r}]);return n})(n,t);for(const[{key:t,value:r}]of Object.values(o))t&&e.res.setHeader(t,r)},H=(e,t)=>{var r;for(const[n,o]of Object.entries(t.headers||[])){const t=o.map((({key:e})=>e)),i=o.map((({value:e})=>e)).join(";");i&&e.res.setHeader(null!==(r=t[0])&&void 0!==r?r:n,i)}};const O=(e,t,r,n)=>{const{apis:o}=t,i=((e,t)=>{const{basePath:r,i18n:n}=t;if(r){if(!e.startsWith(r))return(null==n?void 0:n.defaultLocale)?`/${n.defaultLocale}/404`:"/404";e=e.slice(r.length)}return e.endsWith("/")&&(e=e.slice(0,-1)),""===e?"/":e})(e,r),s=o.nonDynamic[i];if(s)return{isApi:!0,page:s};const a=!n&&function(e,t){const r=q(e,t),n=t.rewrites;for(const e of n){const t=T(r,e.source);if(!t)continue;const n=t.params,o=A(e.destination,n);if(!o)return;const i=Object.keys(n).filter((e=>"nextInternalLocale"!==e)).filter((t=>!e.destination.endsWith(`:${t}`)&&!e.destination.includes(`:${t}/`))).map((e=>{const t=n[e];return"string"==typeof t?`${e}=${t}`:t.map((t=>`${e}=${t}`)).join("&")})).filter((e=>e)).join("&");if(i){const e=o.includes("?")?"&":"?";return`${o}${e}${i}`}return o}}(e,r);if(a){const e=function(e,t){if(t.i18n){const r=t.i18n.locales;for(const t of r){const r=`/${t}`;if(e===r)return"/";if(e.startsWith(`${r}/`))return`${e.slice(r.length)}`}}return e}(a,r),[n,o]=e.split("?");if((u=n).startsWith("http://")||u.startsWith("https://"))return{isExternal:!0,path:n,querystring:o};const i=O(n,t,r,!0);return i?{...i,querystring:o}:i}var u;const c=((e,t)=>{for(const{file:r,regex:n}of t)if(new RegExp(n,"i").test(e))return r})(i,o.dynamic);return c?{isApi:!0,page:c}:void 0};function L(e,t,r){let n;if(t){const[r,o]=e.split("?");n=`${r}?${t}${o?`&${o}`:""}`}else n=e;const i=r;return{isRedirect:!0,status:i,statusDescription:o.STATUS_CODES[i]||"",headers:{location:[{key:"Location",value:n}],refresh:308===r?[{key:"Refresh",value:`0;url=${n}`}]:[]}}}const S=(e,t)=>{const{headers:r}=e;return function(e,t){var r;if(t&&t.username&&t.password){const n="Basic "+Buffer.from(t.username+":"+t.password).toString("base64");if(!e||(null===(r=e[0])||void 0===r?void 0:r.value)!==n)return{isUnauthorized:!0,status:401,statusDescription:"Unauthorized",body:"Unauthorized",headers:{"www-authenticate":[{key:"WWW-Authenticate",value:"Basic"}]}}}}(r.authorization,t.authentication)},N=(e,t)=>{const r=function(e,t){var r;const n=q(e.uri,t),o=null!==(r=t.redirects)&&void 0!==r?r:[];for(const e of o){const t=T(n,e.source);if(t){const r=A(e.destination,t.params);return r?{path:r,statusCode:e.statusCode}:null}}return null}(e,t);if(r){const{path:t,statusCode:n}=r;return L(t,e.querystring,n)}},j=(e,t,r)=>{const n=S(e,t);if(n)return n;const o=((e,t)=>{const r=function(e,t){const r=e.headers.host;if(r&&r.length>0){const n=r[0].value,o=t.domainRedirects;if(o&&o[n])return`${o[n]}${e.uri}`}}(e,t);if(r)return L(r,e.querystring,308)})(e,t)||N(e,r);return o||O(e.uri,t,r)},k=async(e,t,r,n)=>{const o=(e=>{var t;const[r,n]=(null!==(t=e.req.url)&&void 0!==t?t:"").split("?"),o={};for(const[t,r]of Object.entries(e.req.headers))r&&Array.isArray(r)?o[t.toLowerCase()]=r.map((e=>({key:t,value:e}))):r&&(o[t.toLowerCase()]=[{key:t,value:r}]);return{headers:o,querystring:n,uri:r}})(e),i=j(o,t,r);if(!i)return(e=>{e.res.statusCode=404,e.res.statusMessage="Not Found",e.res.end("Not Found")})(e);if(i.querystring&&(e.req.url=`${e.req.url}${o.querystring?"&":"?"}${i.querystring}`),i.isApi){const{page:t}=i;return P(e,r),void n(t).default(e.req,e.res)}return i.isRedirect||i.isUnauthorized?((e,t)=>{H(e,t),e.res.statusCode=t.status,e.res.statusMessage=t.statusDescription,e.res.end()})(e,i):i},M=["connection","expect","keep-alive","proxy-authenticate","proxy-authorization","proxy-connection","trailer","upgrade","x-accel-buffering","x-accel-charset","x-accel-limit-rate","x-accel-redirect","x-cache","x-forwarded-proto","x-real-ip"],W=["x-amz-cf-","x-amzn-","x-edge-"];function z(e){const t=e.toLowerCase();for(const e of W)if(t.startsWith(e))return!0;return M.includes(t)}exports.handler=async e=>{var t;const r=e.Records[0].cf.request,n=a.default,o=s.default,{req:i,res:u,responsePromise:c}=y(e.Records[0].cf,{enableHTTPCompression:o.enableHTTPCompression}),d=await k({req:i,res:u,responsePromise:c},o,n,(e=>require(`./${e}`)));if(d){const{path:e}=d;await async function(e,t,r,n){const{default:o}=await Promise.resolve().then((function(){return require("./index-9e574644.js")})),i={};let s;if(Object.assign(i,t.headers),i.hasOwnProperty("host")&&delete i.host,n){const r=Buffer.from(n,"base64").toString("utf8");s=await o(e,{headers:i,method:t.method,body:r,compress:!1,redirect:"manual"})}else s=await o(e,{headers:i,method:t.method,compress:!1,redirect:"manual"});for(const[e,t]of s.headers.entries())g(e)||r.setHeader(e,t);r.statusCode=s.status,r.end(await s.buffer())}(e,i,u,null===(t=r.body)||void 0===t?void 0:t.data)}const f=await c;return f.headers&&function(e){for(const t in e)z(t)&&delete e[t]}(f.headers),f};
