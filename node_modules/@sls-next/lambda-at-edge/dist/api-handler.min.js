"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./manifest.json"),t=require("./routes-manifest.json"),r=require("stream"),n=require("zlib"),o=require("http"),i=require("url"),s=require("https");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=a(e),c=a(t),f=a(r),l=a(n),d=a(o),p=a(i),h=a(s);const y={"accept-encoding":!0,"content-length":!0,"if-modified-since":!0,"if-none-match":!0,"if-range":!0,"if-unmodified-since":!0,"transfer-encoding":!0,via:!0},m={202:"Accepted",502:"Bad Gateway",400:"Bad Request",409:"Conflict",100:"Continue",201:"Created",417:"Expectation Failed",424:"Failed Dependency",403:"Forbidden",504:"Gateway Timeout",410:"Gone",505:"HTTP Version Not Supported",418:"I'm a teapot",419:"Insufficient Space on Resource",507:"Insufficient Storage",500:"Server Error",411:"Length Required",423:"Locked",420:"Method Failure",405:"Method Not Allowed",301:"Moved Permanently",302:"Moved Temporarily",207:"Multi-Status",300:"Multiple Choices",511:"Network Authentication Required",204:"No Content",203:"Non Authoritative Information",406:"Not Acceptable",404:"Not Found",501:"Not Implemented",304:"Not Modified",200:"OK",206:"Partial Content",402:"Payment Required",308:"Permanent Redirect",412:"Precondition Failed",428:"Precondition Required",102:"Processing",407:"Proxy Authentication Required",431:"Request Header Fields Too Large",408:"Request Timeout",413:"Request Entity Too Large",414:"Request-URI Too Long",416:"Requested Range Not Satisfiable",205:"Reset Content",303:"See Other",503:"Service Unavailable",101:"Switching Protocols",307:"Temporary Redirect",429:"Too Many Requests",401:"Unauthorized",422:"Unprocessable Entity",415:"Unsupported Media Type",305:"Use Proxy"},b={enableHTTPCompression:!1},g=(e,{enableHTTPCompression:t,rewrittenUri:r}=b)=>{const{request:n,response:o={headers:{}}}=e,i={headers:{}},s=new f.default.Readable,a=Object.assign(s,d.default.IncomingMessage.prototype);a.url=r||n.uri,a.method=n.method,a.rawHeaders=[],a.headers={},a.connection={},n.querystring&&(a.url=a.url+"?"+n.querystring);const u=n.headers||{};for(const e of Object.keys(u)){const t=u[e];t.forEach((e=>{a.rawHeaders.push(e.key),a.rawHeaders.push(e.value)})),a.headers[e]=t[0].value}a.getHeader=e=>a.headers[e.toLowerCase()],a.getHeaders=()=>a.headers,n.body&&n.body.data&&a.push(n.body.data,n.body.encoding?"base64":void 0),a.push(null);const c=new f.default;c.finished=!1,Object.defineProperty(c,"statusCode",{get:()=>i.status,set(e){i.status=e,i.statusDescription=m[e]}}),c.headers={},c.writeHead=(e,t)=>(i.status=e,t&&(c.headers=Object.assign(c.headers,t)),c),c.write=e=>{i.body||(i.body=Buffer.from("")),i.body=Buffer.concat([i.body,Buffer.isBuffer(e)?e:Buffer.from(e)])};let p=t&&(e=>{let t=!1;const r=e["accept-encoding"];if(r)for(let e=0;e<r.length;e++){const{value:n}=r[e];-1!==n.split(",").map((e=>e.split(";")[0].trim())).indexOf("gzip")&&(t=!0)}return t})(u);const h=new Promise((e=>{c.end=t=>{!0!==c.finished&&(c.finished=!0,t&&c.write(t),c.statusCode||(c.statusCode=200),i.body&&(i.bodyEncoding="base64",i.body=p?l.default.gzipSync(i.body).toString("base64"):Buffer.from(i.body).toString("base64")),i.headers=((e,t)=>{const r={},n={};return Object.entries(t).forEach((([e,t])=>{n[e.toLowerCase()]=t})),Object.keys(e).forEach((t=>{const o=t.toLowerCase(),i=e[t];y[o]?n[o]&&(r[o]=n[o]):(r[o]=[],i instanceof Array?i.forEach((e=>{r[o].push({key:t,value:e.toString()})})):r[o].push({key:t,value:i.toString()}))})),r})(c.headers,o.headers),p&&(i.headers["content-encoding"]=[{key:"Content-Encoding",value:"gzip"}]),e(i))}}));return c.setHeader=(e,t)=>{c.headers[e.toLowerCase()]=t},c.removeHeader=e=>{delete c.headers[e.toLowerCase()]},c.getHeader=e=>c.headers[e.toLowerCase()],c.getHeaders=()=>c.headers,c.hasHeader=e=>!!c.getHeader(e),{req:a,res:c,responsePromise:h}};g.SPECIAL_NODE_HEADERS=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];var v=g;function w(e,t){void 0===t&&(t={});for(var r=function(e){for(var t=[],r=0;r<e.length;){var n=e[r];if("*"!==n&&"+"!==n&&"?"!==n)if("\\"!==n)if("{"!==n)if("}"!==n)if(":"!==n)if("("!==n)t.push({type:"CHAR",index:r,value:e[r++]});else{var o=1,i="";if("?"===e[a=r+1])throw new TypeError('Pattern cannot start with "?" at '+a);for(;a<e.length;)if("\\"!==e[a]){if(")"===e[a]){if(0==--o){a++;break}}else if("("===e[a]&&(o++,"?"!==e[a+1]))throw new TypeError("Capturing groups are not allowed at "+a);i+=e[a++]}else i+=e[a++]+e[a++];if(o)throw new TypeError("Unbalanced pattern at "+r);if(!i)throw new TypeError("Missing pattern at "+r);t.push({type:"PATTERN",index:r,value:i}),r=a}else{for(var s="",a=r+1;a<e.length;){var u=e.charCodeAt(a);if(!(u>=48&&u<=57||u>=65&&u<=90||u>=97&&u<=122||95===u))break;s+=e[a++]}if(!s)throw new TypeError("Missing parameter name at "+r);t.push({type:"NAME",index:r,value:s}),r=a}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),n=t.prefixes,o=void 0===n?"./":n,i="[^"+T(t.delimiter||"/#?")+"]+?",s=[],a=0,u=0,c="",f=function(e){if(u<r.length&&r[u].type===e)return r[u++].value},l=function(e){var t=f(e);if(void 0!==t)return t;var n=r[u],o=n.type,i=n.index;throw new TypeError("Unexpected "+o+" at "+i+", expected "+e)},d=function(){for(var e,t="";e=f("CHAR")||f("ESCAPED_CHAR");)t+=e;return t};u<r.length;){var p=f("CHAR"),h=f("NAME"),y=f("PATTERN");if(h||y){var m=p||"";-1===o.indexOf(m)&&(c+=m,m=""),c&&(s.push(c),c=""),s.push({name:h||a++,prefix:m,suffix:"",pattern:y||i,modifier:f("MODIFIER")||""})}else{var b=p||f("ESCAPED_CHAR");if(b)c+=b;else if(c&&(s.push(c),c=""),f("OPEN")){m=d();var g=f("NAME")||"",v=f("PATTERN")||"",w=d();l("CLOSE"),s.push({name:g||(v?a++:""),pattern:g&&!v?i:v,prefix:m,suffix:w,modifier:f("MODIFIER")||""})}else l("END")}}return s}function x(e,t){return function(e,t){void 0===t&&(t={});var r=S(t),n=t.encode,o=void 0===n?function(e){return e}:n,i=t.validate,s=void 0===i||i,a=e.map((function(e){if("object"==typeof e)return new RegExp("^(?:"+e.pattern+")$",r)}));return function(t){for(var r="",n=0;n<e.length;n++){var i=e[n];if("string"!=typeof i){var u=t?t[i.name]:void 0,c="?"===i.modifier||"*"===i.modifier,f="*"===i.modifier||"+"===i.modifier;if(Array.isArray(u)){if(!f)throw new TypeError('Expected "'+i.name+'" to not repeat, but got an array');if(0===u.length){if(c)continue;throw new TypeError('Expected "'+i.name+'" to not be empty')}for(var l=0;l<u.length;l++){var d=o(u[l],i);if(s&&!a[n].test(d))throw new TypeError('Expected all "'+i.name+'" to match "'+i.pattern+'", but got "'+d+'"');r+=i.prefix+d+i.suffix}}else if("string"!=typeof u&&"number"!=typeof u){if(!c){var p=f?"an array":"a string";throw new TypeError('Expected "'+i.name+'" to be '+p)}}else{d=o(String(u),i);if(s&&!a[n].test(d))throw new TypeError('Expected "'+i.name+'" to match "'+i.pattern+'", but got "'+d+'"');r+=i.prefix+d+i.suffix}}else r+=i}return r}}(w(e,t),t)}function E(e,t){var r=[];return function(e,t,r){void 0===r&&(r={});var n=r.decode,o=void 0===n?function(e){return e}:n;return function(r){var n=e.exec(r);if(!n)return!1;for(var i=n[0],s=n.index,a=Object.create(null),u=function(e){if(void 0===n[e])return"continue";var r=t[e-1];"*"===r.modifier||"+"===r.modifier?a[r.name]=n[e].split(r.prefix+r.suffix).map((function(e){return o(e,r)})):a[r.name]=o(n[e],r)},c=1;c<n.length;c++)u(c);return{path:i,index:s,params:a}}}(C(e,r,t),r,t)}function T(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function S(e){return e&&e.sensitive?"":"i"}function P(e,t,r){return function(e,t,r){void 0===r&&(r={});for(var n=r.strict,o=void 0!==n&&n,i=r.start,s=void 0===i||i,a=r.end,u=void 0===a||a,c=r.encode,f=void 0===c?function(e){return e}:c,l="["+T(r.endsWith||"")+"]|$",d="["+T(r.delimiter||"/#?")+"]",p=s?"^":"",h=0,y=e;h<y.length;h++){var m=y[h];if("string"==typeof m)p+=T(f(m));else{var b=T(f(m.prefix)),g=T(f(m.suffix));if(m.pattern)if(t&&t.push(m),b||g)if("+"===m.modifier||"*"===m.modifier){var v="*"===m.modifier?"?":"";p+="(?:"+b+"((?:"+m.pattern+")(?:"+g+b+"(?:"+m.pattern+"))*)"+g+")"+v}else p+="(?:"+b+"("+m.pattern+")"+g+")"+m.modifier;else p+="("+m.pattern+")"+m.modifier;else p+="(?:"+b+g+")"+m.modifier}}if(u)o||(p+=d+"?"),p+=r.endsWith?"(?="+l+")":"$";else{var w=e[e.length-1],x="string"==typeof w?d.indexOf(w[w.length-1])>-1:void 0===w;o||(p+="(?:"+d+"(?="+l+"))?"),x||(p+="(?="+d+"|"+l+")")}return new RegExp(p,S(r))}(w(e,r),t,r)}function C(e,t,r){return e instanceof RegExp?function(e,t){if(!t)return e;var r=e.source.match(/\((?!\?)/g);if(r)for(var n=0;n<r.length;n++)t.push({name:n,prefix:"",suffix:"",modifier:"",pattern:""});return e}(e,t):Array.isArray(e)?function(e,t,r){var n=e.map((function(e){return C(e,t,r).source}));return new RegExp("(?:"+n.join("|")+")",S(r))}(e,t,r):P(e,t,r)}function O(e,t){return E(t,{decode:decodeURIComponent})(e)}function j(e,t){try{const r=e.toLowerCase();if(r.startsWith("https://")||r.startsWith("http://")){const{origin:r,pathname:n}=new URL(e),o=`${r}${x(n,{encode:encodeURIComponent})(t)}`;return!e.endsWith("/")&&o.endsWith("/")?o.slice(0,-1):o}{const r=e.replace(/\?/g,"\\?");return x(r,{encode:encodeURIComponent})(t)}}catch(t){return console.error(`Could not compile destination ${e}, returning null instead. Error: ${t}`),null}}function R(e,t,r){let n;if(t){const[r,o]=e.split("?");n=`${r}?${t}${o?"&"+o:""}`}else n=e;const i=r.toString();return{status:i,statusDescription:o.STATUS_CODES[i],headers:{location:[{key:"Location",value:n}],refresh:308===r?[{key:"Refresh",value:"0;url="+n}]:[]}}}const A=["connection","expect","keep-alive","proxy-authenticate","proxy-authorization","proxy-connection","trailer","upgrade","x-accel-buffering","x-accel-charset","x-accel-limit-rate","x-accel-redirect","x-cache","x-forwarded-proto","x-real-ip","content-length","host","transfer-encoding","via","content-encoding"],B=["x-amz-cf-","x-amzn-","x-edge-"];function q(e){const t=e.toLowerCase();for(const e of B)if(t.startsWith(e))return!0;return A.includes(t)}const L=c.default.basePath,H=e=>(e.startsWith(L)&&(e=e.slice(L.length)),e),k=e=>{const{apis:{dynamic:t,nonDynamic:r}}=e;return e=>{if(L&&e.startsWith(L)&&(e=e.slice(L.length)),r[e])return r[e];for(const r in t){const{file:n,regex:o}=t[r];if(new RegExp(o,"i").test(e))return n}return null}},z=f.default.Readable,U=Symbol("buffer"),$=Symbol("type");class I{constructor(){this[$]="";const e=arguments[0],t=arguments[1],r=[];let n=0;if(e){const t=e,o=Number(t.length);for(let e=0;e<o;e++){const o=t[e];let i;i=o instanceof Buffer?o:ArrayBuffer.isView(o)?Buffer.from(o.buffer,o.byteOffset,o.byteLength):o instanceof ArrayBuffer?Buffer.from(o):o instanceof I?o[U]:Buffer.from("string"==typeof o?o:String(o)),n+=i.length,r.push(i)}}this[U]=Buffer.concat(r);let o=t&&void 0!==t.type&&String(t.type).toLowerCase();o&&!/[^\u0020-\u007E]/.test(o)&&(this[$]=o)}get size(){return this[U].length}get type(){return this[$]}text(){return Promise.resolve(this[U].toString())}arrayBuffer(){const e=this[U],t=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);return Promise.resolve(t)}stream(){const e=new z;return e._read=function(){},e.push(this[U]),e.push(null),e}toString(){return"[object Blob]"}slice(){const e=this.size,t=arguments[0],r=arguments[1];let n,o;n=void 0===t?0:t<0?Math.max(e+t,0):Math.min(t,e),o=void 0===r?e:r<0?Math.max(e+r,0):Math.min(r,e);const i=Math.max(o-n,0),s=this[U].slice(n,n+i),a=new I([],{type:arguments[2]});return a[U]=s,a}}function N(e,t,r){Error.call(this,e),this.message=e,this.type=t,r&&(this.code=this.errno=r.code),Error.captureStackTrace(this,this.constructor)}let _;Object.defineProperties(I.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}}),Object.defineProperty(I.prototype,Symbol.toStringTag,{value:"Blob",writable:!1,enumerable:!1,configurable:!0}),N.prototype=Object.create(Error.prototype),N.prototype.constructor=N,N.prototype.name="FetchError";try{_=require("encoding").convert}catch(e){}const M=Symbol("Body internals"),D=f.default.PassThrough;function F(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.size;let o=void 0===n?0:n;var i=r.timeout;let s=void 0===i?0:i;null==e?e=null:G(e)?e=Buffer.from(e.toString()):V(e)||Buffer.isBuffer(e)||("[object ArrayBuffer]"===Object.prototype.toString.call(e)?e=Buffer.from(e):ArrayBuffer.isView(e)?e=Buffer.from(e.buffer,e.byteOffset,e.byteLength):e instanceof f.default||(e=Buffer.from(String(e)))),this[M]={body:e,disturbed:!1,error:null},this.size=o,this.timeout=s,e instanceof f.default&&e.on("error",(function(e){const r="AbortError"===e.name?e:new N(`Invalid response body while trying to fetch ${t.url}: ${e.message}`,"system",e);t[M].error=r}))}function W(){var e=this;if(this[M].disturbed)return F.Promise.reject(new TypeError("body used already for: "+this.url));if(this[M].disturbed=!0,this[M].error)return F.Promise.reject(this[M].error);let t=this.body;if(null===t)return F.Promise.resolve(Buffer.alloc(0));if(V(t)&&(t=t.stream()),Buffer.isBuffer(t))return F.Promise.resolve(t);if(!(t instanceof f.default))return F.Promise.resolve(Buffer.alloc(0));let r=[],n=0,o=!1;return new F.Promise((function(i,s){let a;e.timeout&&(a=setTimeout((function(){o=!0,s(new N(`Response timeout while trying to fetch ${e.url} (over ${e.timeout}ms)`,"body-timeout"))}),e.timeout)),t.on("error",(function(t){"AbortError"===t.name?(o=!0,s(t)):s(new N(`Invalid response body while trying to fetch ${e.url}: ${t.message}`,"system",t))})),t.on("data",(function(t){if(!o&&null!==t){if(e.size&&n+t.length>e.size)return o=!0,void s(new N(`content size at ${e.url} over limit: ${e.size}`,"max-size"));n+=t.length,r.push(t)}})),t.on("end",(function(){if(!o){clearTimeout(a);try{i(Buffer.concat(r,n))}catch(t){s(new N(`Could not create Buffer from response body for ${e.url}: ${t.message}`,"system",t))}}}))}))}function G(e){return"object"==typeof e&&"function"==typeof e.append&&"function"==typeof e.delete&&"function"==typeof e.get&&"function"==typeof e.getAll&&"function"==typeof e.has&&"function"==typeof e.set&&("URLSearchParams"===e.constructor.name||"[object URLSearchParams]"===Object.prototype.toString.call(e)||"function"==typeof e.sort)}function V(e){return"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&"function"==typeof e.constructor&&"string"==typeof e.constructor.name&&/^(Blob|File)$/.test(e.constructor.name)&&/^(Blob|File)$/.test(e[Symbol.toStringTag])}function K(e){let t,r,n=e.body;if(e.bodyUsed)throw new Error("cannot clone body after it is used");return n instanceof f.default&&"function"!=typeof n.getBoundary&&(t=new D,r=new D,n.pipe(t),n.pipe(r),e[M].body=t,n=r),n}function Z(e){return null===e?null:"string"==typeof e?"text/plain;charset=UTF-8":G(e)?"application/x-www-form-urlencoded;charset=UTF-8":V(e)?e.type||null:Buffer.isBuffer(e)||"[object ArrayBuffer]"===Object.prototype.toString.call(e)||ArrayBuffer.isView(e)?null:"function"==typeof e.getBoundary?"multipart/form-data;boundary="+e.getBoundary():e instanceof f.default?null:"text/plain;charset=UTF-8"}function Y(e){const t=e.body;return null===t?0:V(t)?t.size:Buffer.isBuffer(t)?t.length:t&&"function"==typeof t.getLengthSync&&(t._lengthRetrievers&&0==t._lengthRetrievers.length||t.hasKnownLength&&t.hasKnownLength())?t.getLengthSync():null}F.prototype={get body(){return this[M].body},get bodyUsed(){return this[M].disturbed},arrayBuffer(){return W.call(this).then((function(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}))},blob(){let e=this.headers&&this.headers.get("content-type")||"";return W.call(this).then((function(t){return Object.assign(new I([],{type:e.toLowerCase()}),{[U]:t})}))},json(){var e=this;return W.call(this).then((function(t){try{return JSON.parse(t.toString())}catch(t){return F.Promise.reject(new N(`invalid json response body at ${e.url} reason: ${t.message}`,"invalid-json"))}}))},text(){return W.call(this).then((function(e){return e.toString()}))},buffer(){return W.call(this)},textConverted(){var e=this;return W.call(this).then((function(t){return function(e,t){if("function"!=typeof _)throw new Error("The package `encoding` must be installed to use the textConverted() function");const r=t.get("content-type");let n,o,i="utf-8";r&&(n=/charset=([^;]*)/i.exec(r));o=e.slice(0,1024).toString(),!n&&o&&(n=/<meta.+?charset=(['"])(.+?)\1/i.exec(o));!n&&o&&(n=/<meta[\s]+?http-equiv=(['"])content-type\1[\s]+?content=(['"])(.+?)\2/i.exec(o),n||(n=/<meta[\s]+?content=(['"])(.+?)\1[\s]+?http-equiv=(['"])content-type\3/i.exec(o),n&&n.pop()),n&&(n=/charset=(.*)/i.exec(n.pop())));!n&&o&&(n=/<\?xml.+?encoding=(['"])(.+?)\1/i.exec(o));n&&(i=n.pop(),"gb2312"!==i&&"gbk"!==i||(i="gb18030"));return _(e,"UTF-8",i).toString()}(t,e.headers)}))}},Object.defineProperties(F.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0}}),F.mixIn=function(e){for(const t of Object.getOwnPropertyNames(F.prototype))if(!(t in e)){const r=Object.getOwnPropertyDescriptor(F.prototype,t);Object.defineProperty(e,t,r)}},F.Promise=global.Promise;const J=/[^\^_`a-zA-Z\-0-9!#$%&'*+.|~]/,Q=/[^\t\x20-\x7e\x80-\xff]/;function X(e){if(e=""+e,J.test(e)||""===e)throw new TypeError(e+" is not a legal HTTP header name")}function ee(e){if(e=""+e,Q.test(e))throw new TypeError(e+" is not a legal HTTP header value")}function te(e,t){t=t.toLowerCase();for(const r in e)if(r.toLowerCase()===t)return r}const re=Symbol("map");class ne{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;if(this[re]=Object.create(null),e instanceof ne){const t=e.raw(),r=Object.keys(t);for(const e of r)for(const r of t[e])this.append(e,r)}else if(null==e);else{if("object"!=typeof e)throw new TypeError("Provided initializer must be an object");{const t=e[Symbol.iterator];if(null!=t){if("function"!=typeof t)throw new TypeError("Header pairs must be iterable");const r=[];for(const t of e){if("object"!=typeof t||"function"!=typeof t[Symbol.iterator])throw new TypeError("Each header pair must be iterable");r.push(Array.from(t))}for(const e of r){if(2!==e.length)throw new TypeError("Each header pair must be a name/value tuple");this.append(e[0],e[1])}}else for(const t of Object.keys(e)){const r=e[t];this.append(t,r)}}}}get(e){X(e=""+e);const t=te(this[re],e);return void 0===t?null:this[re][t].join(", ")}forEach(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,r=oe(this),n=0;for(;n<r.length;){var o=r[n];const i=o[0],s=o[1];e.call(t,s,i,this),r=oe(this),n++}}set(e,t){t=""+t,X(e=""+e),ee(t);const r=te(this[re],e);this[re][void 0!==r?r:e]=[t]}append(e,t){t=""+t,X(e=""+e),ee(t);const r=te(this[re],e);void 0!==r?this[re][r].push(t):this[re][e]=[t]}has(e){return X(e=""+e),void 0!==te(this[re],e)}delete(e){X(e=""+e);const t=te(this[re],e);void 0!==t&&delete this[re][t]}raw(){return this[re]}keys(){return se(this,"key")}values(){return se(this,"value")}[Symbol.iterator](){return se(this,"key+value")}}function oe(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"key+value";const r=Object.keys(e[re]).sort();return r.map("key"===t?function(e){return e.toLowerCase()}:"value"===t?function(t){return e[re][t].join(", ")}:function(t){return[t.toLowerCase(),e[re][t].join(", ")]})}ne.prototype.entries=ne.prototype[Symbol.iterator],Object.defineProperty(ne.prototype,Symbol.toStringTag,{value:"Headers",writable:!1,enumerable:!1,configurable:!0}),Object.defineProperties(ne.prototype,{get:{enumerable:!0},forEach:{enumerable:!0},set:{enumerable:!0},append:{enumerable:!0},has:{enumerable:!0},delete:{enumerable:!0},keys:{enumerable:!0},values:{enumerable:!0},entries:{enumerable:!0}});const ie=Symbol("internal");function se(e,t){const r=Object.create(ae);return r[ie]={target:e,kind:t,index:0},r}const ae=Object.setPrototypeOf({next(){if(!this||Object.getPrototypeOf(this)!==ae)throw new TypeError("Value of `this` is not a HeadersIterator");var e=this[ie];const t=e.target,r=e.kind,n=e.index,o=oe(t,r);return n>=o.length?{value:void 0,done:!0}:(this[ie].index=n+1,{value:o[n],done:!1})}},Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]())));function ue(e){const t=Object.assign({__proto__:null},e[re]),r=te(e[re],"Host");return void 0!==r&&(t[r]=t[r][0]),t}Object.defineProperty(ae,Symbol.toStringTag,{value:"HeadersIterator",writable:!1,enumerable:!1,configurable:!0});const ce=Symbol("Response internals"),fe=d.default.STATUS_CODES;class le{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};F.call(this,e,t);const r=t.status||200,n=new ne(t.headers);if(null!=e&&!n.has("Content-Type")){const t=Z(e);t&&n.append("Content-Type",t)}this[ce]={url:t.url,status:r,statusText:t.statusText||fe[r],headers:n,counter:t.counter}}get url(){return this[ce].url||""}get status(){return this[ce].status}get ok(){return this[ce].status>=200&&this[ce].status<300}get redirected(){return this[ce].counter>0}get statusText(){return this[ce].statusText}get headers(){return this[ce].headers}clone(){return new le(K(this),{url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected})}}F.mixIn(le.prototype),Object.defineProperties(le.prototype,{url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}}),Object.defineProperty(le.prototype,Symbol.toStringTag,{value:"Response",writable:!1,enumerable:!1,configurable:!0});const de=Symbol("Request internals"),pe=p.default.parse,he=p.default.format,ye="destroy"in f.default.Readable.prototype;function me(e){return"object"==typeof e&&"object"==typeof e[de]}class be{constructor(e){let t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};me(e)?t=pe(e.url):(t=e&&e.href?pe(e.href):pe(""+e),e={});let n=r.method||e.method||"GET";if(n=n.toUpperCase(),(null!=r.body||me(e)&&null!==e.body)&&("GET"===n||"HEAD"===n))throw new TypeError("Request with GET/HEAD method cannot have body");let o=null!=r.body?r.body:me(e)&&null!==e.body?K(e):null;F.call(this,o,{timeout:r.timeout||e.timeout||0,size:r.size||e.size||0});const i=new ne(r.headers||e.headers||{});if(null!=o&&!i.has("Content-Type")){const e=Z(o);e&&i.append("Content-Type",e)}let s=me(e)?e.signal:null;if("signal"in r&&(s=r.signal),null!=s&&!function(e){const t=e&&"object"==typeof e&&Object.getPrototypeOf(e);return!(!t||"AbortSignal"!==t.constructor.name)}(s))throw new TypeError("Expected signal to be an instanceof AbortSignal");this[de]={method:n,redirect:r.redirect||e.redirect||"follow",headers:i,parsedURL:t,signal:s},this.follow=void 0!==r.follow?r.follow:void 0!==e.follow?e.follow:20,this.compress=void 0!==r.compress?r.compress:void 0===e.compress||e.compress,this.counter=r.counter||e.counter||0,this.agent=r.agent||e.agent}get method(){return this[de].method}get url(){return he(this[de].parsedURL)}get headers(){return this[de].headers}get redirect(){return this[de].redirect}get signal(){return this[de].signal}clone(){return new be(this)}}function ge(e){Error.call(this,e),this.type="aborted",this.message=e,Error.captureStackTrace(this,this.constructor)}F.mixIn(be.prototype),Object.defineProperty(be.prototype,Symbol.toStringTag,{value:"Request",writable:!1,enumerable:!1,configurable:!0}),Object.defineProperties(be.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0}}),ge.prototype=Object.create(Error.prototype),ge.prototype.constructor=ge,ge.prototype.name="AbortError";const ve=f.default.PassThrough,we=p.default.resolve;function xe(e,t){if(!xe.Promise)throw new Error("native promise missing, set fetch.Promise to your favorite alternative");return F.Promise=xe.Promise,new xe.Promise((function(r,n){const o=new be(e,t),i=function(e){const t=e[de].parsedURL,r=new ne(e[de].headers);if(r.has("Accept")||r.set("Accept","*/*"),!t.protocol||!t.hostname)throw new TypeError("Only absolute URLs are supported");if(!/^https?:$/.test(t.protocol))throw new TypeError("Only HTTP(S) protocols are supported");if(e.signal&&e.body instanceof f.default.Readable&&!ye)throw new Error("Cancellation of streamed requests with AbortSignal is not supported in node < 8");let n=null;if(null==e.body&&/^(POST|PUT)$/i.test(e.method)&&(n="0"),null!=e.body){const t=Y(e);"number"==typeof t&&(n=String(t))}n&&r.set("Content-Length",n),r.has("User-Agent")||r.set("User-Agent","node-fetch/1.0 (+https://github.com/bitinn/node-fetch)"),e.compress&&!r.has("Accept-Encoding")&&r.set("Accept-Encoding","gzip,deflate");let o=e.agent;return"function"==typeof o&&(o=o(t)),r.has("Connection")||o||r.set("Connection","close"),Object.assign({},t,{method:e.method,headers:ue(r),agent:o})}(o),s=("https:"===i.protocol?h.default:d.default).request,a=o.signal;let u=null;const c=function(){let e=new ge("The user aborted a request.");n(e),o.body&&o.body instanceof f.default.Readable&&o.body.destroy(e),u&&u.body&&u.body.emit("error",e)};if(a&&a.aborted)return void c();const p=function(){c(),b()},y=s(i);let m;function b(){y.abort(),a&&a.removeEventListener("abort",p),clearTimeout(m)}a&&a.addEventListener("abort",p),o.timeout&&y.once("socket",(function(e){m=setTimeout((function(){n(new N("network timeout at: "+o.url,"request-timeout")),b()}),o.timeout)})),y.on("error",(function(e){n(new N(`request to ${o.url} failed, reason: ${e.message}`,"system",e)),b()})),y.on("response",(function(e){clearTimeout(m);const t=function(e){const t=new ne;for(const r of Object.keys(e))if(!J.test(r))if(Array.isArray(e[r]))for(const n of e[r])Q.test(n)||(void 0===t[re][r]?t[re][r]=[n]:t[re][r].push(n));else Q.test(e[r])||(t[re][r]=[e[r]]);return t}(e.headers);if(xe.isRedirect(e.statusCode)){const i=t.get("Location"),s=null===i?null:we(o.url,i);switch(o.redirect){case"error":return n(new N("uri requested responds with a redirect, redirect mode is set to error: "+o.url,"no-redirect")),void b();case"manual":if(null!==s)try{t.set("Location",s)}catch(e){n(e)}break;case"follow":if(null===s)break;if(o.counter>=o.follow)return n(new N("maximum redirect reached at: "+o.url,"max-redirect")),void b();const i={headers:new ne(o.headers),follow:o.follow,counter:o.counter+1,agent:o.agent,compress:o.compress,method:o.method,body:o.body,signal:o.signal,timeout:o.timeout,size:o.size};return 303!==e.statusCode&&o.body&&null===Y(o)?(n(new N("Cannot follow redirect with body being a readable stream","unsupported-redirect")),void b()):(303!==e.statusCode&&(301!==e.statusCode&&302!==e.statusCode||"POST"!==o.method)||(i.method="GET",i.body=void 0,i.headers.delete("content-length")),r(xe(new be(s,i))),void b())}}e.once("end",(function(){a&&a.removeEventListener("abort",p)}));let i=e.pipe(new ve);const s={url:o.url,status:e.statusCode,statusText:e.statusMessage,headers:t,size:o.size,timeout:o.timeout,counter:o.counter},c=t.get("Content-Encoding");if(!o.compress||"HEAD"===o.method||null===c||204===e.statusCode||304===e.statusCode)return u=new le(i,s),void r(u);const f={flush:l.default.Z_SYNC_FLUSH,finishFlush:l.default.Z_SYNC_FLUSH};if("gzip"==c||"x-gzip"==c)return i=i.pipe(l.default.createGunzip(f)),u=new le(i,s),void r(u);if("deflate"!=c&&"x-deflate"!=c){if("br"==c&&"function"==typeof l.default.createBrotliDecompress)return i=i.pipe(l.default.createBrotliDecompress()),u=new le(i,s),void r(u);u=new le(i,s),r(u)}else{e.pipe(new ve).once("data",(function(e){i=8==(15&e[0])?i.pipe(l.default.createInflate()):i.pipe(l.default.createInflateRaw()),u=new le(i,s),r(u)}))}})),function(e,t){const r=t.body;null===r?e.end():V(r)?r.stream().pipe(e):Buffer.isBuffer(r)?(e.write(r),e.end()):r.pipe(e)}(y,o)}))}xe.isRedirect=function(e){return 301===e||302===e||303===e||307===e||308===e},xe.Promise=global.Promise;var Ee=Object.freeze({__proto__:null,default:xe,Headers:ne,Request:be,Response:le,FetchError:N});exports.handler=async e=>{var t;const r=e.Records[0].cf.request,n=c.default,o=u.default,i=r.headers.authorization,s=function(e,t){if(t&&t.username&&t.password&&e!=="Basic "+Buffer.from(t.username+":"+t.password).toString("base64"))return{status:"401",statusDescription:"Unauthorized",body:"Unauthorized",headers:{"www-authenticate":[{key:"WWW-Authenticate",value:"Basic"}]}};return null}(i?i[0].value:null,u.default.authentication);if(s)return s;const a=function(e,t){const r=e.headers.host;if(r&&r.length>0){const n=r[0].value,o=t.domainRedirects;if(o&&o[n])return`${o[n]}${e.uri}`}return null}(r,o);if(a)return R(a,r.querystring,308);const f=function(e,t){const r=t.redirects;for(const t of r){const r=O(e,t.source);if(r){const e=j(t.destination,r.params);return e?{redirectPath:e,statusCode:t.statusCode}:null}}return null}(r.uri,n);if(f)return R(f.redirectPath,r.querystring,f.statusCode);let l=o.apis.nonDynamic[H(r.uri)],d=H(r.uri);if(!l){const o=function(e,t,r,n){const o=t.rewrites;for(const t of o){const o=O(e,t.source);if(o){const i=j(t.destination,o.params);if(e===i){const e=r(n);if("pages/404.html"===e||"pages/_error.js"===e)continue}return i}}return null}(r.uri,n,k(u.default),d);if(o){if(function(e){return e.startsWith("http://")||e.startsWith("https://")}(o)){const[n,i]=o.split("?");r.querystring?r.querystring=`${r.querystring}${i?"&"+i:""}`:r.querystring=""+(null!=i?i:"");const{req:s,res:a,responsePromise:c}=v(e.Records[0].cf,{enableHTTPCompression:u.default.enableHTTPCompression});return await async function(e,t,r,n){const{default:o}=await Promise.resolve().then((function(){return Ee}));let i,s={};if(Object.assign(s,t.headers),s.hasOwnProperty("host")&&delete s.host,n){const r=Buffer.from(n,"base64").toString("utf8");i=await o(e,{headers:s,method:t.method,body:r})}else i=await o(e,{headers:s,method:t.method});for(const[e,t]of i.headers.entries())q(e)||r.setHeader(e,t);r.statusCode=i.status;const a=await i.text();r.end(a)}(n+(r.querystring?"?":"")+r.querystring,s,a,null===(t=r.body)||void 0===t?void 0:t.data),await c}r.uri=o,d=H(r.uri)}}const p=k(u.default)(d);if(!p)return{status:"404"};const h=require("./"+p),{req:y,res:m,responsePromise:b}=v(e.Records[0].cf,{enableHTTPCompression:o.enableHTTPCompression});h.default(y,m);const g=await b;return function(e,t,r){if(t.headers)for(const n of r.headers)if(O(e,n.source))for(const e of n.headers)if(e.key&&e.value){const r=e.key.toLowerCase();t.headers[r]=[{key:r,value:e.value}]}}(r.uri,g,n),g};
